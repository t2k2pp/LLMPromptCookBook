# レシピ1-5: エッジケースの考慮と対処

## 課題（Problem）
LLMを使用したコード生成では、主要な機能は適切に実装されるものの、以下のようなエッジケースが見落とされがちです：

- 異常系の処理
- 境界値の処理
- 並行処理時の競合
- リソース制約への対応
- 予期しない入力値

## 解決方法（Solution）
プロンプトの中でエッジケースを明示的に指定し、それらへの対処方法を要求します。

1. エッジケースの体系的な列挙
2. 具体的な処理方法の指定
3. テストケースの要求
4. エラーハンドリングの明確化

## プロンプト例

### 基本的なプロンプト
```
ユーザー登録APIを実装してください。
```

### エッジケースを考慮したプロンプト
```
タスク：ユーザー登録APIの実装

基本仕様：
- メールアドレスとパスワードによる登録
- プロフィール情報の保存
- 確認メールの送信

考慮すべきエッジケース：

1. 入力値の異常
   - 無効なメールアドレスフォーマット
   - パスワード強度不足
   - 禁止文字の使用
   - 極端に長い入力値

2. 重複と競合
   - メールアドレスの重複
   - 同時登録リクエスト
   - 一時的なデータ不整合

3. システムの制約
   - データベース接続エラー
   - メール送信失敗
   - ストレージ容量不足
   - 高負荷時の処理

4. セキュリティ考慮
   - インジェクション攻撃
   - レート制限超過
   - 不正なIPからのアクセス
   - トークンの有効期限切れ

要求事項：
1. 各エッジケースに対する適切なエラーハンドリング
2. エラーメッセージの国際化対応
3. 詳細なログ記録
4. リトライ機構の実装
5. テストケースの提供
```

## 実装例
- [エッジケースを考慮したユーザー登録API実装](https://github.com/t2k2pp/LLMPromptCookBook/blob/main/chapter%201/recipe%201-5/recipe1-5-code.ts)
- [ユーザー登録処理フロー](https://github.com/t2k2pp/LLMPromptCookBook/blob/main/chapter%201/recipe%201-5/recipe1-5-flow.mermaid)

## エッジケースの体系的な分類

### 1. 入力値の異常

#### データ型の異常
- null/undefined値
- 予期しない型の値
- シリアライズ/デシリアライズエラー

#### 境界値の問題
- 値の範囲外
- バッファオーバーフロー
- 整数オーバーフロー

#### フォーマットの問題
- 不正な文字コード
- 無効なJSON
- 不正なエンコーディング

### 2. リソースの制約

#### メモリ制約
- メモリ不足
- 大きすぎるペイロード
- メモリリーク

#### ディスク制約
- ディスク容量不足
- ファイルディスクリプタの枯渇
- I/Oエラー

#### ネットワーク制約
- タイムアウト
- 接続エラー
- 帯域幅制限

### 3. 並行処理の問題

#### 競合状態
- データ競合
- デッドロック
- ライブロック

#### タイミング問題
- レースコンディション
- 非同期処理のエラー
- イベント順序の問題

## エッジケース対策のベストプラクティス

1. **防御的プログラミング**
   - 入力値の厳密な検証
   - 型安全性の確保
   - 不変条件の保証

2. **エラー処理戦略**
   - 階層的なエラー設計
   - トランザクション管理
   - ロールバック機構

3. **リソース管理**
   - プーリングの活用
   - リソースの制限設定
   - クリーンアップ処理

4. **監視とログ**
   - 詳細なエラーログ
   - メトリクスの収集
   - アラート設定

5. **テスト戦略**
   - ユニットテスト
   - 統合テスト
   - カオスエンジニアリング

## プロンプトでのエッジケース指定パターン

### 1. チェックリスト方式
```
以下のエッジケースに対する処理を実装してください：

データ検証:
- [ ] 空の入力値
- [ ] 最大長超過
- [ ] 不正な文字

エラー処理:
- [ ] DB接続エラー
- [ ] 外部APIタイムアウト
- [ ] 並行処理の競合

リソース管理:
- [ ] メモリ使用量の制限
- [ ] コネクションプーリング
- [ ] バッファサイズの制御
```

### 2. シナリオベース方式
```
以下のシナリオを考慮した実装を行ってください：

シナリオ1: 高負荷時の動作
- 同時リクエスト数が急増
- DBコネクションの枯渇
- キャッシュの高負荷

シナリオ2: ネットワーク障害
- 断続的な接続エラー
- 応答遅延
- 部分的なタイムアウト

シナリオ3: データ異常
- 破損したデータ
- 不整合な状態
- バージョン競合
```

### 3. 制約ベース方式
```
以下の制約を満たすように実装してください：

性能要件:
- レイテンシ: 99%tile < 100ms
- スループット: 1000 req/sec
- メモリ使用量: < 512MB

耐障害性:
- 自動リトライ
- フォールバック処理
- グレースフルデグラデーション

セキュリティ:
- 入力検証
- レート制限
- エラー情報の制御
```

## Tips

1. **エッジケースの優先順位付け**
   - 発生頻度の評価
   - ビジネスインパクトの考慮
   - 対応コストの試算

2. **段階的な対応**
   - クリティカルな問題から対応
   - モニタリングの強化
   - フィードバックループの確立

3. **ドキュメント化**
   - エッジケースの一覧化
   - 対応方針の明確化
   - レビュー基準の設定

## Warning

- すべてのエッジケースを完璧に処理しようとしない
- 過度な防御的プログラミングを避ける
- ビジネス要件とのバランスを取る

## 関連レシピ
- レシピ1-3: 制約条件の明示的な指定
- レシピ1-6: 出力フォーマットの制御
- レシピ2-2: APIエンドポイントの実装

## まとめ

エッジケースへの対応は、以下の点に注意して進めることが重要です：

1. 体系的なエッジケースの洗い出し
2. 優先順位に基づく対応計画
3. 適切なエラー処理の実装
4. 継続的なモニタリングと改善

プロンプトでエッジケースを指定する際は、具体的なシナリオや制約を明確に示し、期待する動作を詳細に説明することで、より適切な実装を得ることができます。
